# 今日日志（2026-02-10）

## 变更概览
- 新增4卡训练脚本，保持单卡流程完全不变
- 执行了2次训练实验（v25、v26）

## 修改文件
- `scripts/mr/mr_qwen_qwen_4gpu.sh`：新增多卡并行训练脚本（192行），使用torchrun启动，支持PRL_*环境变量覆盖所有关键参数
- `docs/multi_gpu_training_guide.md`：新增多卡训练完整文档（包含2卡/4卡启动命令、参数说明、故障排查）
- `wandb/debug*.log`、`wandb/latest-run`：训练日志符号链接更新（指向最新运行）
- `output/v25-20260210-095552/`：训练输出目录（早期实验）
- `output/v26-20260210-100232/`：训练输出目录（后续实验，completions.jsonl 76KB）

## 关键调整
- **平台无交互设计**：所有参数通过PRL_*环境变量配置，支持2/4/8卡灵活切换，无需修改脚本
- **Fail-fast验证**：启动前自动检查 global_batch_size % num_generations == 0，不满足则退出并打印详细错误
- **保守默认值**：dataloader_num_workers=0（避免多进程问题），vllm显存0.40，适合平台提交
- **启动方式**：使用 `torchrun --nproc_per_node=N -m swift.cli.rlhf` 实现真正的分布式训练（无device_map固定）
- **参数优化**：降低max_completion_length（1024→768）、调整eval/save_steps（100→200）以提速

## 当前状态
- 单卡脚本 `mr_qwen_qwen.sh` 未修改，可继续使用
- 4卡脚本已通过语法检查和参数验证测试
- 两次训练实验已完成，日志正常记录

## 明日计划
- 验证4卡脚本实际训练效果和加速比
- 根据实验结果调优vllm显存比例和batch配置

---

## 快速启动命令

### 单卡训练（原有流程）
```bash
cd /qiuyeqing/llama_prl/PRL-REDO/PRL-addENV; \
source /qiuyeqing/tools/miniconda3/etc/profile.d/conda.sh; \
conda activate prl_clean; \
export WANDB_MODE=offline; \
bash scripts/mr/mr_qwen_qwen.sh
```

### 2卡训练（本地测试）
```bash
cd /qiuyeqing/llama_prl/PRL-REDO/PRL-addENV; \
source /qiuyeqing/tools/miniconda3/etc/profile.d/conda.sh; \
conda activate prl_clean; \
export WANDB_MODE=offline; \
PRL_CUDA_VISIBLE_DEVICES=0,1 \
PRL_NPROC_PER_NODE=2 \
PRL_PER_DEVICE_TRAIN_BATCH_SIZE=4 \
PRL_NUM_GENERATIONS=2 \
PRL_NUM_INFER_WORKERS=2 \
bash scripts/mr/mr_qwen_qwen_4gpu.sh
```

### 4卡训练（平台提交）
```bash
cd /qiuyeqing/llama_prl/PRL-REDO/PRL-addENV; \
source /qiuyeqing/tools/miniconda3/etc/profile.d/conda.sh; \
conda activate prl_clean; \
export WANDB_MODE=offline; \
PRL_CUDA_VISIBLE_DEVICES=0,1,2,3 \
PRL_NPROC_PER_NODE=4 \
PRL_PER_DEVICE_TRAIN_BATCH_SIZE=4 \
PRL_NUM_GENERATIONS=2 \
PRL_NUM_INFER_WORKERS=4 \
bash scripts/mr/mr_qwen_qwen_4gpu.sh
```

### 4卡训练（使用默认值，最简命令）
```bash
cd /qiuyeqing/llama_prl/PRL-REDO/PRL-addENV; \
source /qiuyeqing/tools/miniconda3/etc/profile.d/conda.sh; \
conda activate prl_clean; \
export WANDB_MODE=offline; \
bash scripts/mr/mr_qwen_qwen_4gpu.sh
```

**说明：**
- 单卡/多卡命令流格式完全一致，仅脚本名和环境变量不同
- 多卡脚本支持所有PRL_*环境变量覆盖（详见 `docs/multi_gpu_training_guide.md`）
- 默认配置已优化为4卡，可直接运行最简命令
